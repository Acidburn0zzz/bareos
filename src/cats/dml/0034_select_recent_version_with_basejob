SELECT FileId, Job.JobId AS JobId, FileIndex, File.PathId AS PathId, File.FilenameId AS FilenameId, LStat, MD5, DeltaSeq,
       Job.JobTDate AS JobTDate
  FROM Job, File, (
      SELECT MAX(JobTDate) AS JobTDate, PathId, FilenameId
        FROM (
            SELECT JobTDate, PathId, FilenameId
              FROM File
              JOIN Job
             USING (JobId)
             WHERE File.JobId IN (%s)
             UNION ALL
            SELECT JobTDate, PathId, FilenameId
              FROM BaseFiles
              JOIN File
             USING (FileId)
              JOIN Job
                ON (BaseJobId    = Job.JobId)
             WHERE BaseFiles.JobId IN (%s)
             ) AS tmp
       GROUP BY PathId, FilenameId
       ) AS T1
 WHERE (
          Job.JobId IN (
         SELECT DISTINCT BaseJobId
           FROM BaseFiles
          WHERE JobId IN (%s)
          )
       OR Job.JobId IN (%s)
       )
   AND T1.JobTDate   = Job.JobTDate
   AND Job.JobId     = File.JobId
   AND T1.PathId     = File.PathId
   AND T1.FilenameId = File.FilenameId
